### Arch Installation Tool - Currently for Non-EFI Only
pacman -Sy --noconfirm pacman-contrib dialog
### Disk Selection Menu
devicelist=$(lsblk -dplnx size -o name,size | grep -Ev "boot|rpmb|loop" | tac)
device=$(dialog --stdout --menu "Select installtion disk" 0 0 0 ${devicelist}) || exit 1
clear

### Automatic Formatting
parted --script "${device}" -- mklabel msdos \
  mkpart primary ext4 1Mib 129MiB \
  set 1 boot on \
  mkpart primary ext4 129MiB 100%
part_boot="$(ls ${device}* | grep -E "^${device}p?1$")"
part_root="$(ls ${device}* | grep -E "^${device}p?2$")"
wipefs "${part_boot}"
wipefs "${part_root}"
mkfs.ext4 "${part_boot}"
mkfs.ext4 "${part_root}"
mount "${part_root}" /mnt
mkdir /mnt/boot
mount "${part_boot}" /mnt/boot

### Install and Initial Setup
pacstrap /mnt base base-devel linux linux-firmware grub sudo networkmanager vim

### fstab
genfstab -U /mnt >> /mnt/etc/fstab

### locale and timezone setup

ln -sf /usr/share/zoneinfo/America/Detroit /etc/localtime
arch-chroot /mnt hwclock --systohc
sed -i "s/^#${LOCALE} UTF-8/${LOCALE} UTF-8/" /mnt/etc/locale.gen
arch-chroot /mnt locale-gen
echo "LANG=${LOCALE}" > /mnt/etc/locale.conf

### hostname
hostname=$(dialog --stdout --inputbox "Enter hostname" 0 0) || exit 1
clear
: ${hostname:?"hostname cannot be empty"}
echo "${hostname}" > /mnt/etc/hostname

### Further setup
arch-chroot /mnt mkinitcpio -p linux
arch-chroot /mnt systemctl enable NetworkManager
arch-chroot /mnt grub-install /dev/sda
arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg

### Root Password
password=$(dialog --stdout --passwordbox "Enter root password" 0 0) || exit 1
clear
: ${password:?"password cannot be empty"}
password2=$(dialog --stdout --passwordbox "Enter root password again" 0 0) || exit 1
clear
[[ "$password" == "$password2" ]] || ( echo "Passwords did not match"; exit 1; )
echo "root:$password" | chpasswd --root /mnt


### User Creation with sudo
username=$(dialog --stdout --inputbox "Enter Username" 0 0) || exit 1
clear
: ${username:?"username cannot be empty"}
arch-chroot /mnt useradd -m -s /bin/bash --groups wheel ${username}
password=$(dialog --stdout --passwordbox "Enter user password" 0 0) || exit 1
clear
: ${password:?"password cannot be empty"}
password2=$(dialog --stdout --passwordbox "Enter user password again" 0 0) || exit 1
clear
[[ "$password" == "$password2" ]] || ( echo "Passwords did not match"; exit 1; )
echo "user:$password" | chpasswd --${username} /mnt
export EDITOR="tee -a"
echo "%wheel ALL=(ALL) ALL" | arch-chroot /mnt visudo

echo "I use arch BTW"
umount -R /mnt
reboot

